DROP PROCEDURE IF EXISTS UpdateBestsellers;

DELIMITER $$

CREATE PROCEDURE UpdateBestsellers()
BEGIN
	DECLARE BOOK_STATUS BOOLEAN DEFAULT false;
    DECLARE AVERAGE INT;
    DECLARE FINISHED INT DEFAULT 0;
    DECLARE BESTSELLER CURSOR FOR SELECT BOOK_ID FROM RENTS;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET FINISHED = 1;
    OPEN BESTSELLER;    
	WHILE (FINISHED = 0) DO
		FETCH BESTSELLER INTO AVERAGE;
			IF (FINISHED = 0) THEN
				IF (AVERAGE > 2) THEN
                SET BOOK_STATUS = true;
                UPDATE BOOKS SET BESTSELLER = BOOK_STATUS
                WHERE BOOK_ID = AVERAGE;
                COMMIT;
                END IF;
			commit;
            END IF;
    END WHILE;
	CLOSE BESTSELLER;
END $$

DELIMITER ;
